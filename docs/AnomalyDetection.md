# AIOps-异常检测

## 异常检测

AIOps的目前是一个炙手可热的发展方向，其中异常检测，基本上是作为实践AIOps的敲门砖或者第一步。其实异常检测不只是在运维领域使用的，在工业、金融、安全等诸多行业里都有具体的使用场景，比方说欺诈检测、入侵检测等。而在运维领域主要是针对监控数据和日志，发现基础设施，应用，业务，日志等异常，并根据具体异常形成最终对故障的判断，从而减少人工去设定告警的工作量，提升故障发现的准确率。在很多实践中，其实多数方式就是把其他领域成熟的异常检测方式迁移到运维领域，在运维的异常检测场景中，其实是不完全试用，需要根据运维的特点来制定相应的算法和处理方式才能达到相应的效果。本文也就是对aiops领域的异常检测做一个具体的探讨和尝试。

要做异常检测，首先要说明什么是异常检测。举个图片识别的例子，比方说，拿出1W张机器猫的图片让异常检测的模型去训练，训练得到了这样的图片就是机器猫，然后再给一张加菲猫的图片，通过异常检测训练好的模型，能够发现这张图片跟之前的图片不一样，是一张异常的图片，这种不一样不能判断是之前机器猫的检测，就是异常检测。其实这里有两个很重要的关键点，就是跟之前不一样，为异常。而在运维领域，比方说CPU的使用率，一直是10%左右，突然增加到40%了，这是异常，但是这个很有可能不是故障，所以一定要在运维里理解aiops的异常检测，是发现跟之前情况不一样的情况，并不是发现真实的故障。

那如果异常检测检测的不是故障，那么还有什么价值么？有没有其他办法确定异常检测出来的问题就是故障呢？首先，有些指标，比方接口的成功率，业务的完成率等一些指标出现异常，就很大概率是故障了；还有就是人工可以定义规则来确定什么是故障，比方说cpu使用率连续出现五次异常且平均使用率高于90%定义为异常，这个就要结合专家 系统里的积累的专家的经验来设定具体的故障规则。即使上面的都无法做到，aiops的异常检测已然可以作为日常巡检的重要指标和故障定位和排查的重要参照，对于运维的故障处理也是极具贡献的。

## 主机监控指标的异常检测

说完了异常检测，再说主机监控指标的异常检测，为什么要限定到这个范围，其他的范围不能异常检测么？答案当然是否定，不过主机监控指标有着一些特性，在一定的范围内讨论异常检测，才会有很高的针对性。比方说在后面也会讨论数据的稳定性，主机的监控指标一般是稳定数据或接近稳定数据，主机监控指标主要有CPU使用率，内存使用率，磁盘使用率，网络上传下载字节数。这些指标的特征，与主机上所部署的进程和主机的硬件配置有着重要的关系，指标的特征会影响到是否可以模型复用，这个在后面也会描述。

## aiops异常检测常用的算法

异常检测有着太多的算法甚至方法，个人认为常用且可用的有如下几个分类：
* 统计学方法：比方说6sigema，统计学的这些方法并不需要模型学习，而且计算相当快，在很多大厂对于海量主机的异常检测，也不乏使用统计学方法的提高检测效率。适合海量指标，需要极快能检测得到异常的情况，比方说网络异常。
* 监控学习的方法：通过标记异常数据，实现一个分类模型，对于所有已知分类可信度都达不到阈值的数据认定为异常，这种方法其实更加精确，但是对于海量数据的标记数据工作就显的比较困难，及时使用半监督学习也是对海量指标捉襟见肘。但是对于重要业务指标比较适用，比方说电商的订单量、转化率等。
* 无监督学习的方法：比较常见的方法如孤立森林、onesvm，通过无监督学习历史数据然后判断新数据是否不符合历史数据的特性，深度的学习的也有类似的比方说AutoEncoder，这类方法应该说适应大多数的异常检测场景
* 时序预测的方法：通过时序数据预测数据的变化，发现预测数据和真实数据的误差超过阈值，判定为异常。这种方法常用在有周期变化的不稳定数据上，一般都是预测效果比较好的情况。常用的算法比方说SARIMA、LSTM。该方法也比较适合具体的重要业务指标。
* 其他：比方说通过距离的方法，深度学习VAE，GAN等方法，在异常检测上都有各自的特点和适用范围。


## 学件和模型复用

说到了好多算法，以无监督学习为例，本质上一个指标或者一个资源的一个指标的数据特性不同，那么异常的情况也不同，训练的模型理论上要一一对应，如果有海量的资源指标那么就有海量的训练和模型。另外AI的复杂度比较高，对于运维来说，扔出来这么多算法，没有人了解具体的原理，如果需要使用，需要吧相关的数据规约和训练方法，评估方式都封装成一个可以迁移的组件，运维可以更加便捷的使用这种组件，那么“学件”这个概念就来。学件就是为了能重复使用，迁移方法，易于理解而营运而生的概念。具体地说，比方我们做了一个对CPU使用异常检测的学件，那我就规约检测的数据格式和训练的数据格式，使用者不用知道里面具体的数据预处理、特征工程、特征选择、模型选择、超参调整、模型评估等一系列的东西，这个都由算法工程师配置好，运维只要按照规约将需要的训练数据给学件，学件就可以进行模型优化；把检测数据给学件，学件就可以进行异常检测。运维也不用关心具体是那台主机的CPU使用率的异常检测，学件根据规约有一定的适用范围，比方说他可以适应数据库主机的CPU使用率异常检测，或者所有主机的异常检测，只要根据规约进行训练和使用即可。说到这里，是不是感觉所有人都可以使用学件做aiops了，是的，这个就是他的目标，但是路缺很长。

学件遇到的第一个问题就是模型复用，上面说了每个主机的cpu使用率情况都不一样，如果用到机器学习和深度学习，就产生了大量的数据模型，这个存储难度就很大，如果每次检测都需要重新训练，这个读取训练数据的IO量也比较大，对数据库也有压力，所以需要一种方式能够达到学件里的模型尽量的复用。当然学件还需要很多问题如何限定指标范围，如何达到AutoML实现自动模型生成和评估。想要实现一个健壮的学件还是充满挑战。


## 特征工程和特征选择

其实核心就是特征工程，是用单指标，还是多指标的异常检测，多指标是哪些指标放到一起，单指标如何做转换。
* 单指标：对于时序的单指标来说，一般考虑验证数据是stationary还是non-stationary，如果是non-stationary是否需要通过log或者diff将数据转换成stattionary的数据，当然通过STL分解，来对残差进行异常检测也是一种途径；当然也可以考虑增加数据维度的方法，比方对比数据一小时前的平均值差异度，是否出现连续增长等维度来增加异常检测的判断；还有就是要去除特殊情况，比方说业务指标在活动期间的指标值会跟大，跟平常不符，单不是异常，需要单独处理，是针对活动做一个模型来特殊验证还是通过归一（或者diff）的方式来判断，都需要根据具体问题具体分析。
* 多指标：对于多指标，重要就是要找到哪些指标放到一起会有效果，要根据算法去获取数据的相关性，甚至尝试PCA来做主成分分析，获取指标的依赖程度来提升异常检测的效率。VAR这种对多指标的时序预测的方法，可以用来做预测类的异常检测，当然其他如孤立森林，DBSCAN等方法也都支持多维度的无监督方法

## 异常检测的数据处理

上面说的都是在AI领域异常检测的相关内容，其实异常检测这种AI能力，放入到运维大数据里，才是真正实现了AIOps的异常检测，也就是说需要有运维大数据的支持，才能完成异常检测场景。在很多公司的战略规划里，运维数据管理都下沉形成的运维数据中台，这种中台可以复用业务的数据中台，也可以单独建设，但是核心内容就是需要有数据中台这种，数据采集，处理，开发，可视化的能力才能完成具体的AIOps场景，单独AIOps会在数据质量，数据治理等问题上陷入泥潭而无法自拔，很难发挥AI的真实价值。


## 总结

总的来说，首先aiops的异常检测是在固定场景下的异常检测，要针对具体的问题和场景利用算法进行变通和实践，照办算法和数据，揉在一起，并不能达到很好的异常检测的效果。只有根据具体场景，利用不同算法，形成可复用的AI能力，在大数据的加持下，才能真正完成AIOps的异常检测场景。

